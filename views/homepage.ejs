<!-- Default home page -->
<link type="text/css" href='http://sailsjs.org/styles/fonts.css' rel='stylesheet'/>
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
<style>
    body {
        margin: 0;
        padding: 0;
        background-color: #EEE;
    }

    #topBar {
        height: 150px;
        width: 100%;
        background-color: #55A9AC;
        -webkit-box-shadow: 0px 2px 6px 0px rgba(0,0,0,0.37);
        -moz-box-shadow: 0px 2px 6px 0px rgba(0,0,0,0.37);
        box-shadow: 0px 2px 6px 0px rgba(0,0,0,0.37);
    }

    #cont {
        margin: -100px auto 0 auto;
        width: 1100px;
    }

    #leftDiv {
        width: 400px;
        float: left;
    }

    #albumArtCont {
        height: 400px;
        width: 400px;
        -webkit-box-shadow: 0px 2px 10px 0px rgba(0,0,0,0.37);
        -moz-box-shadow: 0px 2px 10px 0px rgba(0,0,0,0.37);
        box-shadow: 0px 2px 10px 0px rgba(0,0,0,0.37);
        background-image: url('images/logo.png');
        background-size: 400px 400px;
        margin: 0 0 20px 0;
    }

    #albumArt {
        height: 400px;
        width: 400px;
    }

    .ctrlIcon {
        font-size: 60px;
        color: #55A9AC;
        margin-right: 10px;
        transition: 0.3s all;
        cursor: pointer;
    }

    .ctrlIcon:hover {
        color: #6CC9CD;
    }

    #rightDiv {
        height: 450px;
        width: 650px;
        float: right;
        padding-bottom: 20px;
    }

    #nowPlaying {
        width: 650px;
        height: 70px;
        white-space: nowrap;
        overflow-x: hidden;
        font-family: 'Roboto';
        font-weight: 300;
        margin: 15px 0 40px 0;
    }

        #songNameH {
            font-size: 48px;
            color: white;
        }

        #artistNameH {
            font-size: 32px;
            color: #DDD;
            margin-left: 10px
        }

    .scrolling {
        animation: auto medium infinite scroll normal;
    }

    .queueErr {
        font-size: 48px;
        color: #2c2c2c;
        font-family: 'Roboto';
        font-weight: 300;
        margin-top: 50px;
    }

    .queueBox {
        width: 650px;
        height: 100px;
        padding: 0;
        margin-bottom: 20px;
        background-color: white;
        font-family: 'Roboto';
        font-weight: 300;
        -webkit-box-shadow: 0px 2px 10px 0px rgba(0,0,0,0.37);
        -moz-box-shadow: 0px 2px 10px 0px rgba(0,0,0,0.37);
        box-shadow: 0px 2px 10px 0px rgba(0,0,0,0.37);
    }
        .queueArt {
            width: 100px;
            height: 100px;
            margin: 0 20px 0 0;
            float: left;
        }
        .queueInd {
            width: 100px;
            height: 40px;
            background-color: rgba(0,0,0,0.5);
            margin: 60px 0 0 -120px;
            text-align: center;
            color: white;
            font-size: 31px;
            float: left;
        }
        .queueTextCont {
            width: 430px;
            float: left;
            white-space: nowrap;
            overflow-x: hidden;
            margin-top: 18px
        }
        .queueScore {
            float: right;
            text-align: right;
            white-space: nowrap;
            overflow-x: visible;
            margin: 20px 20px 0 0;
            color: #555;
            font-size: 20px;
        }
        .songName {
            font-size: 24px;
            color: #2c2c2c;
        }
        .artistName {
            font-size: 20px;
            color: #555555;
        }
</style>
<script type="text/javascript">
    var totalCount = 1;
    var isPlaying = false;
    var isQueued = false;

    var queue = [
        {
            'id':          '1',
            'songName':    'Give Me A Try',
            'artistName':  'The Wombats',
            'streamUrl':   'https://p.scdn.co/mp3-preview/bb6054ad62641eef7aab2004f8d7b7da9b32cf26',
            'coverUrl':    'https://i.scdn.co/image/866f416a61a2e663954cc9580a0e018cc1432920',
            'score':       0,
            'shortcode':   '4822'
        },
        {
            'id':          '2',
            'songName':    'The Bay',
            'artistName':  'Metronomy',
            'streamUrl':   'https://p.scdn.co/mp3-preview/c4ab35f9a2cbc7683bc90f56cfb6d255a12c783b',
            'coverUrl':    'https://i.scdn.co/image/a6b1db4555057091e63285834e38bf2308fe6a1b',
            'score':       0,
            'shortcode':   '5275'
        },
        {
            'id':          '3',
            'songName':    'Men\'s Needs',
            'artistName':  'The Cribs',
            'streamUrl':   'https://p.scdn.co/mp3-preview/54763012753bb57be414e72ca5c549181e7cea7f',
            'coverUrl':    'https://i.scdn.co/image/211dc80f980f1054e59b61c869b53f557850f5c8',
            'score':       1,
            'shortcode':   '8452'
        }
    ];

    var shortcodes = [
        '4822',
        '5275',
        '8452'
    ];

    function genCode(){
        return Math.floor((Math.random() * 9000) + 1000);
    }

    function popQueue(playNext){
        if(playNext){
            $('#nowPlaying').html('');
            $('#queued').html('');
        } else {
            $('#queued').html('');
        }
        
        var i = 0;
        var to = queue.length;

        function addThis(){
            setTimeout(function(){
                var newSong = queue[i];

                $('#queued').append('\
                    <div id="'+newSong.id+'" style="opacity:0; margin-left: 30px" class="queueBox">\
                        <img class="queueArt" src="'+newSong.coverUrl+'">\
                        <div class="queueInd">'+newSong.shortcode+'</div>\
                        <div class="queueTextCont">\
                            <span class="songName">'+newSong.songName+'</span><br>\
                            <span class="artistName">'+newSong.artistName+'</span>\
                        </div>\
                        <span id="'+newSong.id+'Score" class="queueScore">Score: '+newSong.score+'</span><br>\
                    </div>\
                ');

                $('#'+newSong.id).animate({
                    opacity: 1,
                    marginLeft: '0'
                },300);

                i++;
                totalCount++;

                isQueued = true;

                if(i != to) addThis()

            },100);
        }

        addThis();
        if(playNext) next();
    }

    function addToQueue(d){
        for(var i in queue){
            if(queue[i].id == d.id){
                queue[i].score++;
                sortQueue();
                return true;
            }
        }
        queue.push(d);

        var newSong = queue[queue.length-1];
        console.log(JSON.stringify(newSong));

        newSong.score = 0;

        var thisCode = genCode();
        newSong.shortcode = thisCode;
        shortcodes.push(thisCode);

        $('#queued').append('\
            <div id="'+newSong.id+'" style="opacity:0; margin-left: 30px" class="queueBox">\
                <img class="queueArt" src="'+newSong.coverUrl+'">\
                <div class="queueInd">'+newSong.shortcode+'</div>\
                <div class="queueTextCont">\
                    <span class="songName">'+newSong.songName+'</span><br>\
                    <span class="artistName">'+newSong.artistName+'</span>\
                </div>\
                <span id="'+newSong.id+'Score" class="queueScore">Score: '+newSong.score+'</span><br>\
            </div>\
        ');

        $('#'+newSong.id).animate({
            opacity: 1,
            marginLeft: '0'
        },300);
    }

    function removeFromQueue(id){

    }

    function playPause(){
        var button = document.getElementById('play');
        var audio = document.getElementById('stream');
        var isOn = false;

        var isPlaying = !audio.paused;

        if(isPlaying){
            audio.pause();
            $('#play').html('<i class="fa fa-play"></i>');
        } else {
            audio.play();
            $('#play').html('<i class="fa fa-pause"></i>');
        }                       
    }

    function next(){

        var audio = document.getElementById('stream');

        if(queue.length == 0){
            isPlaying = false;

            $('#streamSrc').attr('src','');

            $('#nowPlaying').animate({
                opacity: 0,
                marginLeft: '30px'
            },300);

            setTimeout(function(){
                $('#nowPlaying').html('\
                    <span id="songNameH">Nothing Playing.</span>\
                ');
                $('#play').html('<i class="fa fa-play"></i>');
                audio.pause();
                setTimeout(function(){
                    $('#albumArt').animate({
                        opacity: 0
                    },300);
                    $('#nowPlaying').animate({
                        opacity: 1,
                        marginLeft: '0'
                    },300);
                },300);
            },300);

            return false;
        }

        isPlaying = true;

        var newSong = queue[0];
        console.log(JSON.stringify(newSong));

        $('#'+newSong.id).animate({
            opacity: 0,
            marginLeft: '-30px'
        },300);

        setTimeout(function(){
            $('#nowPlaying').animate({
                opacity: 0,
                marginLeft: '30px'
            },300);
            $('#albumArt').animate({
                opacity: 0
            },300);
            setTimeout(function(){
                audio.pause();
                $('#streamSrc').attr('src',newSong.streamUrl);
                $('#nowPlaying').html('\
                    <span id="songNameH">'+newSong.songName+'</span>\
                    <span id="artistNameH">'+newSong.artistName+'</span>\
                ');

                if(($('#songNameH').width() + $('#artistNameH').width() + 10) > $('#nowPlaying').width()){
                    $('#nowPlaying').html('<marquee scrollamount="10">\
                        <span id="songNameH">'+newSong.songName+'</span>\
                        <span id="artistNameH">'+newSong.artistName+'</span></marquee>\
                    ');
                } else {
                    $('#nowPlaying').addClass('scrolling');
                }
                
                $("#albumArt").attr("src",newSong.coverUrl);
                audio.load();
                setTimeout(function(){
                    $('#nowPlaying').animate({
                        opacity: 1,
                        marginLeft: '0'
                    },300);
                    $('#albumArt').animate({
                        opacity: 1
                    },300);

                    audio.play();
                    $('#play').html('<i class="fa fa-pause"></i>');

                    $('#'+newSong.id).animate({
                        height: 0
                    },300);

                    setTimeout(function(){
                        $('#'+newSong.id).remove();

                        queue.shift();
                        shortcodes.shift();

                        if(queue.length == 0){
                            $('#queued').append('\
                                <span class="queueErr">Nothing Queued.</span>\
                            ');
                            isQueued = false;
                        }
                    },300);
                },300);
            },300);
        },100);
    }

    function sortQueue(){
        var j = 0;
        var to = queue.length;

        function removeThis(){
            setTimeout(function(){
                var newSong = queue[j];

                $('#'+newSong.id).animate({
                    opacity: 0,
                    marginLeft: '-30px'
                },300);
             
                j++;

                if(j != to) removeThis()

            },100);
        }

        removeThis();

        queue.sort(function(a,b){return b.score-a.score});
        
        popQueue(false);
    }

    $(window).ready(function(){
        setTimeout(popQueue(true), 500);

        var isPlaying = false;

        $("#stream").bind('ended', function(){
            next();
        });

        console.log('connecting...');
        io.socket.get("/test");
        io.socket.on('connect',function(message){
            console.log('connected!');
            io.socket.on('message',function(message){
                console.log(JSON.stringify(message));
                if(message.type == 'add'){
                    var found = false;
                    for(var i in queue){
                        if(queue[i].id == message.data.id){
                            queue[i].score++;
                            found = true;
                            break;
                        }
                    }
                    if(!found){
                        addToQueue(message.data);
                    } else {
                        sortQueue();
                    }
                } else if(message.type == 'up'){
                    var ind = shortcodes.indexOf(message.code);
                    if(ind > -1){
                        queue[ind].score++;
                        console.log(queue[ind]);
                    }
                } else if(message.type == 'down'){
                    var ind = shortcodes.indexOf(message.code);
                    if(ind > -1){
                        queue[ind].score--;
                        console.log(queue[ind]);
                    }
                }
            });
        });

    });
</script>

<div id="topBar"></div>
<div id="cont">

    <div id="leftDiv">
        <div id="albumArtCont">
            <img id="albumArt">
        </div>
        <span class="ctrlIcon" onclick="playPause()" id="play"><i class="fa fa-play"></i></span>
        <span class="ctrlIcon" style="float: right; margin-right: 0"onclick="next()" id="fwd"><i class="fa fa-forward"></i></span>
    </div>
        
    <div id="rightDiv">
        <div id="nowPlaying" class="scrolling">
            
        </div>
        <div id="queued">
            <span class="queueErr">Nothing Queued.</span>
        </div>
    </div>

</div>

<audio id="stream">
    <source id="streamSrc" src="" type="audio/mpeg" />
</audio>
